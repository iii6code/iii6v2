// SPDX-License-Identifier: GPL-3.0
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//
//      0KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKK0Okdlc:;,......    ......',;cldxO0KKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKKK
//      XNNNNNNNNNNNNNNNNNNNNNNNNNNXX0kdc;'...        .......         ...';coxOKXNNNNNNNNNNNNNNNNNNNNNNNNNNN
//      XNNNNNNNNNNNNNNNNNNNNNNNX0xl;'..              .,;;:,.                ..;cdOXXNNNNNNNNNNNNNNNNNNNNNNN
//      XNNNNNNNNNNNNNNNNNNXNXOo:'.                   .......                    ..;lkKXNNNNNNNNNNNNNNNNNNNN
//      XNNNNNNNNNNNNNNNNNXOo;..              .........................             ..,lkKNNNNXNNNNNNNNNNNNN
//      XNNNNNNNNNNNNXXNKx:..            ..........    'lc'.    ............            .;d0XNNNNNNNNNNNNNNN
//      XNNNNNNNNNNNNX0d;.          ........         .;dddkl.            .......          .'lOXNNNNNNNNNNNNN
//      XNNNNNNNNNNX0d,.         ......             .cx:..,lo'               ......         .'lOXNNNNNNNNNNN
//      XNNNNXNNNNKx,.         .....               .ox;.   .:o,.                 ....         .'o0XNNNNNNNNN
//      XNXNNNNNXOc.        .....                .,dd'      .;l;.                  .....   .... .;xXNNNNNNNN
//      XNNNNNNKd'....... .....                 .;xo.        .'c;.                    .....':;..  .l0XNNNNNN
//      XNNNNX0c. ..'''......                  .ckc.           .:;.                     ....',...  .;OXNNNNN
//      XNNNXO:.   ........                   .ok:.             .;;.                     ......     .,xXNNXX
//      XNNXO;.       ...                    'dx;.               .,;.                      ...        'xXNNN
//      XNXO;.       ...                   .,xx'       .....''''''';:..                     ...        'xXNN
//      XN0:.       ...                   .;kd.  ..,:ldxkOOOOOOOOOkO0Odl:,..                  ...      .,kXN
//      XKl.       ...                   .cko'':ok00Okdlc;;,'''...',;:dkxkkd:..                ..       .:0N
//      Xx'       ...                   .lKOxk00xxxl,.  ....',..      .'..,cddl,.              ...       .oX
//      O:.      ...                  ..dNN0xl;':c::c:'..':odol:..     .... ..:lc,.             ...       ,k
//      d.       ..                 .,o00d:.. .od'  .,cclxxl'.'coc.     ....   ..,,'..           ..       .l
//      :.      ...              ..:xKNO,.   .lO:    .;k0o;.   .'do.     ...      .....          ...       ,
//      '       ..             ..cddx0x'     .xO,   .:dc',:;'.   ;k:.           ..,'...           ..       .
//      .       ..            .:lc,ckd.      .dKc. .cl'.  ..,'. .lO:       ..':ll:,..             ...      .
//      .      ...          .,:,..ckl.       .;0O:,:,.      ...'lOl.   ..;ldkkdo;.                ...      .
//             ...        ..'.. .lkc.         .;kK0o,.......':dOx;..,cdOKKko;..'c:.               ...
//      .      ...       ....  .lk:.           .'coxOkkxxxxkkkxdodkKXXOdc'.    .'dd,.             ...
//      .      ...        ....,dk;.            ..  ..;coxkkOO0KXX0ko:'..         'dOc.            ...      .
//      .       ..          .,dd;,,;;:::;;;;;::clloxkO0KK00Oxdl;'..               .l0d'.          ...      .
//      ,.      ...        .;dc.  ...,;:clloodddddoolc:;'....                      .;OO:.         ......   .
//      c.  .......       .:o;.                                                     .'d0d'.      ....,;'. .:
//      x'  .';,...      .cl'.                                                        .:OO:.     ....;;.. .o
//      0l. ..,'....   .'ol...............................'''',,,,,,;;;:::::ccccclllllookNXd.   ... .... .;0
//      XO,       ...  .coc::cccccccccllllllllllllloooooooooooooooooooooooooooooooolllllllc;.  ...       .dX
//      XXd.       ...  .........................................                             ...       .lKN
//      XNKl.       ...            .:cccccc:;:ccccccc:::cccccccccccccccccccccccc'.           ...       .:0NX
//      XNNKc.       ...          .cXWNXXNKkxokXNWWNNK0NMWWNXNW0OXWNNWWNWWNWWNWWo.          ...       .;OXNN
//      XNNN0l.       ....        .cXNxokKxokllOkdxKNOxXWkloddOdlOXKkK0ONWOdx0WWo.         ...       .;OXNNN
//      XNNNNKo.        ...       .cXNOdokxcddd0klo0WKdOXd;lxkKOd0NWOlokKXOllOWWo.       ...        .c0NNNNN
//      XNNNNNXd'.       ....     .cXWK00XNKO0XXKNXKWN0KNNK00KNNK0XXOdOKKXKNXKNWo.     ....        .lKNNNNNN
//      XNNNNNNXO:.        ....    'oddddddddddddddddddddddddddddddl:coddddddddo;.   ....        .,xXNNNNNNN
//      XNNNNNNNNKd'.        .....                                                 ....        ..l0XNNNNNNNN
//      XNNNNNNNNNXOl..        ......                                           .....         .:kXNNNNNNNNNN
//      XNNNNNNNNNNNXOc..         ......                                    ......          .:xKNNNNNNNNNNNN
//      XNNNNNNNNNNNNNXOl'.          ........                          ........          ..ckKNNNNNNXNNNNNNN
//      XNNNNNNNNNNNNNNNX0d;..       ..'....................................',,.       .,oOXNNNNNNNNNNNNNNNN
//      XNNNNNNNNNNNNNNNNNNXOo;..    ...;;.     ....................      .;,'..   ..,lkKXNNNNNNNNNNNNNNNNNN
//      XNNNNNNNNNNNNNNNNNNNNNKOd:'.    ..                                 ...  ..;lkKXNXNNNNNNNNNNNNNNNNNNN
//      XNNNNNNNNNNNNNNNNNNNNNNNNX0ko:,...                                 ..':lx0XNNNNNXNNNNNNNNNNNNNNNNNNN
//      XNNNNNNNNNNNNNNNNNNNNNNNNNNNNXKOxoc;,....                  ....';:ldOKXXNNNNNNNNNNNNNNNNNNNNNNNNNNNN
//      XNNNNNNNNNNNNNNNNNNNNNNNNNNNXXNNNNXK0kdl:;'.....    .....',:ldk0KXNNNNNXNNNNNNNNNNNNNNNNNNNNNNNNNNNN
//
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @dev            ::              Aron Mauritala Ayuk                                                                                                                                          //
//      @msg            ::              stereo@iii6.xyz                                                                                                                                   //
//      @github         ::              @stereoIII6
//      @twitter        ::              @stereoIII6                                                                                                                                              //
//                                                                                                                                                                                  //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @dev            ::              Juan Xavier Valverde                                                                                                                                    //
//      @msg            ::              juanxavier@iii6.xyz                                                                                                                               //
//      @twitter        ::              @JuanXavier                                                                                                                                             //
//      @github         ::              @JuanXavier                                                                                                                                             //
//                                                                                                                                                                                  //                                                                                                                                                                                 //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @company        ::              Fractio Holding                                                                                                                                                                       //
//      @title          ::              s0xiety Users                                                                                                                            //
//      @description    ::              Friend Interface Contract                                                                                                                           //
//      @version        ::              0.0.1                                                                                                                                       //
//      @purpose        ::              Multinet Friendship Interface                                                                                                           //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

pragma solidity ^0.8.7;

import "../iii6utils/Math/iii6Math.sol";
import "../iii6utils/Misc/iii6Relations.sol";
import "./s0xUsers.sol";

/**
 * @dev soxFriends is the s0xiety contract that takes care or friendships relations and privacy
 * it inherits iii6Math and iii6Relations
 *
 */
contract s0xFriends is iii6Math, iii6Relations {
    // importing s0x user contract struct
    s0xUsers private user;
    // following // address ref user # =>  address privacy user # => Relation Mode Struct ?
    mapping(address => mapping(address => Relations)) private relationToUser;
    mapping(address => bool) public banned;
    // count connections var
    uint256 c;
    uint256 r;
    // connections // address smaller # => address bigger # => uint c connection count
    mapping(address => mapping(address => uint256)) public connection; // connection array
    // follower count // address ref user # => uint follower counter
    mapping(address => uint256) public followerCount;
    // follower count // address ref user # => uint followed counter
    mapping(address => uint256) public myFollowingCount;
    // followers by count //address ref user # => uint follower counter
    mapping(address => mapping(uint256 => address)) public followersByCount;

    /**
     * @dev soxFriends is the s0xiety contract that takes care or friendships relations and privacy
     * @param _usrAdr is the User Contract Adress
     *
     */
    constructor(address _usrAdr) {
        user = s0xUsers(_usrAdr);
    }

    /**
     * @dev shows user account of msg sender
     */
    function showMe() external view returns (string memory) {
        return user.showUser(msg.sender);
    }

    /**
     * @dev shows user account of given address
     * @param _adr address of user account to show
     */
    function showYou(address _adr) external view returns (string memory) {
        return user.showUser(_adr);
    }

    /**
     * @dev shows user relation to msg.sender INTERNAL
     */
    function _detectRelation(uint256 _rel)
        internal
        pure
        returns (Relation rel)
    {
        if (_rel == 0) rel = Relation.Friend;
        if (_rel == 1) rel = Relation.Family;
        if (_rel == 2) rel = Relation.Work;
        if (_rel == 3) rel = Relation.Homies;
        if (_rel == 4) rel = Relation.Partners;
        if (_rel == 5) rel = Relation.Blocked;
    }

    /**
     * @dev shows user msg allowance to msg.sender
     */
    function getMsgAllow(address _sender, address _adr)
        external
        view
        returns (bool)
    {
        return relationToUser[_sender][_adr].BallowsAmsg;
    }

    /**
     * @dev create user relation from sender to adr INTERNAL
     */
    function relate(
        address _adr,
        address _sender,
        uint256 _rel
    ) external returns (uint256) {
        Relation rel = _detectRelation(_rel);
        ++myFollowingCount[_adr];
        followersByCount[_sender][followerCount[_sender]] = _adr;
        ++followerCount[_sender];
        (address s, address l) = _smaller(_adr, _sender);
        // if no connection for this user pair exists
        if (connection[s][l] == 0) {
            ++c;
            connection[s][l] = c;
            relationToUser[_sender][_adr] = Relations(
                r,
                true,
                false,
                false,
                false,
                true,
                false,
                rel,
                Relation.Member
            );
            ++r;
            user.addedConnection(_sender);
            relationToUser[_adr][_sender] = Relations(
                r,
                false,
                true,
                false,
                false,
                false,
                true,
                Relation.Member,
                rel
            );
            ++r;
            return (connection[s][l]);
        }
        // if one sided  connection for this user pair exists
        else if (connection[s][l] == 1) {
            ++c;
            if (relationToUser[_sender][_adr].AprivB == Relation.Member) {
                connection[s][l] = c;
                Relations memory oldRel;
                oldRel = relationToUser[_sender][_adr];
                relationToUser[_sender][_adr] = Relations(
                    r,
                    true,
                    oldRel.BfollowsA,
                    false,
                    oldRel.BbansA,
                    true,
                    oldRel.BallowsAmsg,
                    rel,
                    oldRel.BprivA
                );
                ++r;
                user.addedConnection(_sender);
                relationToUser[_adr][_sender] = Relations(
                    r,
                    oldRel.BfollowsA,
                    true,
                    oldRel.BbansA,
                    false,
                    oldRel.BallowsAmsg,
                    true,
                    oldRel.BprivA,
                    rel
                );
                ++r;
            }
            return (connection[s][l]);
        }
        // if users are two way connected
        else return (connection[s][l]);
    }

    /**
     * @dev count followers of address
     */
    function doFollowerCount(address _adr) external view returns (uint256) {
        return followerCount[_adr];
    }

    /**
     * @dev count how many users address follows
     * @param _adr address of user
     */
    function doFollowingCount(address _adr) external view returns (uint256) {
        return myFollowingCount[_adr];
    }

    /**
     * @dev shows one specific Followers address
     * @param _adr address of user
     * @param _c follower count pointer of user _adr
     */
    function doShowFollower(address _adr, uint256 _c)
        external
        view
        returns (address)
    {
        return followersByCount[_adr][_c];
    }

    /**
     * @dev shows relation fom msg.sender to _adr
     * @param _adr address of user
     * @return rel Relations struct
     */
    function showRelation(address _adr)
        external
        view
        returns (Relations memory rel)
    {
        rel = relationToUser[msg.sender][_adr];
    }

    /**
     * @dev edits one specific Followers address relation status a = msg.sender b = _adr
     * @param _adr address of user
     * @param _fol bool follower
     * @param _msg bool can a msg b
     * @param _ban bool did a ban b
     * @param _rel uint relation gets converted to Relaion enum by _detectRelation()
     */
    function editRelation(
        address _adr,
        bool _fol,
        bool _msg,
        bool _ban,
        uint256 _rel
    ) external returns (Relations memory) {
        return _editRelation(_adr, _fol, _msg, _ban, _rel);
    }

    /**
     * @dev edits one specific Followers address relation status
     * a = msg.sender b = _adr INTERNAL
     * @param _adr address of reciever
     * @param _fol bool a follows b
     * @param _msg bool a allows msgs b
     * @param _ban bool a bans b
     * @param _rel Relation in /iii6Utils/Misc/iii6Relations.sol Relation enum
     * @return rel
     */
    function _editRelation(
        address _adr,
        bool _fol,
        bool _msg,
        bool _ban,
        uint256 _rel
    ) internal returns (Relations memory rel) {
        Relation newRel = _detectRelation(_rel);
        Relations memory hold1 = relationToUser[msg.sender][_adr];
        Relations memory hold2 = relationToUser[_adr][msg.sender];

        /**
         * Relations Struct Scheme
         *
         * @param uint256 id;
         * @param bool AfollowsB;
         * @param bool BfollowsA;
         * @param bool AbansB;
         * @param bool BbansA;
         * @param bool AallowsBmsg;
         * @param bool BallowsAmsg;
         * @param Relation AprivB;
         * @param Relation BprivA;
         */
        Relations memory relOut = Relations(
            hold1.id,
            _fol,
            hold1.BfollowsA,
            _ban,
            hold1.BbansA,
            _msg,
            hold1.BallowsAmsg,
            newRel,
            hold1.BprivA
        );
        Relations memory relIn = Relations(
            hold2.id,
            hold2.AfollowsB,
            _fol,
            hold2.AbansB,
            _ban,
            hold2.AallowsBmsg,
            _msg,
            hold2.AprivB,
            newRel
        );
        relationToUser[msg.sender][_adr] = relOut;
        relationToUser[_adr][msg.sender] = relIn;
        rel = relOut;
    }

    function blockAddress(address _adr) external returns (Relations memory) {
        return _editRelation(_adr, false, false, true, 5);
    }
}
